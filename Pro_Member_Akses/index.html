<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>UMT Pro Command Center</title>
    <link rel="icon" type="image/png" href="UMT-Logo - Copy.png">
    
    <script src="data.js"></script>
    
    <script>
      MathJax = {
        tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] }
      };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;600&family=Inter:wght@400;600;700&display=swap');
        :root {
            --bg-main: #0D1117; --bg-panel: #161B22; --border-color: #30363D;
            --text-primary: #C9D1D9; --text-secondary: #8B949E; --accent-cyan: #2F81F7;
            --accent-green: #39D353; --accent-red: #F85149;
        }
        body { background-color: var(--bg-main); color: var(--text-primary); font-family: 'Inter', sans-serif; }
        .font-mono { font-family: 'Fira Code', monospace; }
        .panel {
            background-color: var(--bg-panel);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            padding: 1rem;
        }
        @media (min-width: 768px) {
            .panel {
                padding: 1.5rem;
            }
        }
        .bottom-nav-link.active { color: var(--accent-cyan); }
        .sidebar-link.active { background-color: #30363D; color: white; }
        .card-item { background-color: #21262D; transition: transform 0.2s; cursor: pointer; }
        .card-item:hover { transform: translateY(-4px); background-color: #30363D; }
        .quiz-option { border: 2px solid var(--border-color); }
        .quiz-option:hover { border-color: var(--accent-cyan); }
        .quiz-option.selected { border-color: var(--accent-cyan); background-color: rgba(47, 129, 247, 0.2); }
        .correct-answer { background-color: rgba(57, 211, 83, 0.1); border-left: 4px solid var(--accent-green); }
        .wrong-answer { background-color: rgba(248, 81, 73, 0.1); border-left: 4px solid var(--accent-red); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .nav-btn:disabled { background-color: #30363D; color: #8B949E; cursor: not-allowed; }

        @keyframes slideInRight { from { opacity: 0; transform: translateX(100%); } to { opacity: 1; transform: translateX(0); } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; transform: translateY(-20px); } }
        .toast-in { animation: slideInRight 0.5s forwards; }
        .toast-out { animation: fadeOut 0.5s forwards; }

        .forum-container { background-color: var(--bg-panel); border: 1px solid var(--border-color); border-radius: 0.75rem; padding: 2.5rem 2rem; max-width: 800px; margin: 2rem auto; text-align: center; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); }
        .intro h1 { font-size: 2.25rem; font-weight: 700; color: var(--accent-cyan); margin-bottom: 0.75rem; }
        .intro p { color: var(--text-secondary); max-width: 600px; margin-left: auto; margin-right: auto; line-height: 1.6; }
        .community-links { margin-top: 3rem; padding-top: 2rem; border-top: 1px solid var(--border-color); }
        .community-links h2 { font-size: 1.25rem; font-weight: 600; color: var(--text-primary); margin-bottom: 1.5rem; }
        .community-btn { text-decoration: none; color: white; font-weight: bold; padding: 0.75rem 1.5rem; border-radius: 9999px; display: inline-flex; align-items: center; gap: 0.75rem; transition: all 0.3s ease; border: 2px solid transparent; }
        .community-btn i { font-size: 1.25rem; }
        .community-btn:hover { transform: translateY(-4px); box-shadow: 0 4px 20px rgba(0, 0, 0, 0.25); }
        .whatsapp-btn { background-color: #25D366; }
        .whatsapp-btn:hover { background-color: #1DAA54; }
        .telegram-btn { background-color: #229ED9; }
        .telegram-btn:hover { background-color: #1C84B3; }
        .community-links .subtext { color: var(--text-secondary); margin-top: 1.5rem; font-size: 0.875rem; }

        @media (max-width: 768px) {
            .intro h1 { font-size: 1.75rem; }
            .forum-container { padding: 2rem 1rem; margin: 1rem; }
            .community-btn { width: 100%; justify-content: center; }
        }

        @media (max-width: 640px) {
            #single-explanation-container .text-lg { font-size: 1.125rem; }
            #single-explanation-container .text-sm { font-size: 0.95rem; line-height: 1.5; }
            #single-explanation-container .font-bold { font-size: 1.125rem; }
            .quiz-nav-buttons { flex-direction: column; gap: 0.75rem; }
            .quiz-nav-buttons > button { width: 100%; justify-content: center; }
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes scaleIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.7); z-index: 1000; display: flex; justify-content: center; align-items: center; animation: fadeIn 0.3s ease; }
        .modal-box { background-color: var(--bg-panel); border: 1px solid var(--border-color); border-radius: 0.75rem; padding: 1.5rem; width: 90%; max-width: 450px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3); animation: scaleIn 0.3s ease; }
        .modal-title { font-size: 1.25rem; font-weight: 700; color: var(--text-primary); margin-bottom: 0.75rem; }
        .modal-content { color: var(--text-secondary); line-height: 1.6; margin-bottom: 1.5rem; }
        .modal-buttons { display: flex; justify-content: flex-end; gap: 0.75rem; }
        .modal-btn { padding: 0.5rem 1.25rem; border-radius: 0.5rem; font-weight: 600; border: none; cursor: pointer; transition: background-color 0.2s; }
        .modal-btn-confirm { background-color: var(--accent-cyan); color: white; }
        .modal-btn-confirm:hover { background-color: #2577e3; }
        .modal-btn-danger { background-color: var(--accent-red); color: white; }
        .modal-btn-danger:hover { background-color: #e4433b; }
        .modal-btn-cancel { background-color: #30363D; color: var(--text-primary); }
        .modal-btn-cancel:hover { background-color: #484f58; }
    </style>
</head>
<body class="text-white">

    <div class="flex min-h-screen">
        <aside class="fixed bottom-0 left-0 z-50 w-full h-16 bg-[var(--bg-panel)] border-t border-[var(--border-color)] md:relative md:w-64 md:h-screen md:flex md:flex-col md:border-t-0 md:border-r md:p-6">
            <h1 class="hidden text-xl font-bold mb-10 text-cyan-400 md:block md:text-2xl">UMT Pro</h1>
            <nav id="sidebar-nav" class="no-scrollbar flex overflow-x-auto h-full md:flex-col md:space-y-4 md:h-auto">
                <div class="flex flex-nowrap items-center justify-start gap-2 px-2 md:flex-col md:items-stretch md:gap-0 md:px-0">
                    <a href="#" class="sidebar-link bottom-nav-link flex-shrink-0 w-20 flex flex-col items-center justify-center p-2 text-center text-gray-400 rounded-lg hover:text-white md:w-full md:flex-row md:justify-start md:gap-4 md:hover:bg-gray-700" onclick="event.preventDefault(); navigateTo('dashboard', this)">
                        <i class="fa-solid fa-chart-pie text-lg md:w-6"></i><span class="text-xs mt-1 md:text-base md:mt-0">Dashboard</span>
                    </a>
                    <a href="#" class="sidebar-link bottom-nav-link flex-shrink-0 w-20 flex flex-col items-center justify-center p-2 text-center text-gray-400 rounded-lg hover:text-white md:w-full md:flex-row md:justify-start md:gap-4 md:hover:bg-gray-700" onclick="event.preventDefault(); navigateTo('materi', this)">
                        <i class="fa-solid fa-book text-lg md:w-6"></i><span class="text-xs mt-1 md:text-base md:mt-0">Materi</span>
                    </a>
                    <a href="#" class="sidebar-link bottom-nav-link flex-shrink-0 w-20 flex flex-col items-center justify-center p-2 text-center text-gray-400 rounded-lg hover:text-white md:w-full md:flex-row md:justify-start md:gap-4 md:hover:bg-gray-700" onclick="event.preventDefault(); navigateTo('bank_soal', this)">
                        <i class="fa-solid fa-list-check text-lg md:w-6"></i><span class="text-xs mt-1 md:text-base md:mt-0">Bank Soal</span>
                    </a>
                    <a href="#" class="sidebar-link bottom-nav-link flex-shrink-0 w-20 flex flex-col items-center justify-center p-2 text-center text-gray-400 rounded-lg hover:text-white md:w-full md:flex-row md:justify-start md:gap-4 md:hover:bg-gray-700" onclick="event.preventDefault(); navigateTo('video', this)">
                        <i class="fa-solid fa-video text-lg md:w-6"></i><span class="text-xs mt-1 md:text-base md:mt-0">Video</span>
                    </a>
                    <a href="#" class="sidebar-link bottom-nav-link flex-shrink-0 w-20 flex flex-col items-center justify-center p-2 text-center text-gray-400 rounded-lg hover:text-white md:w-full md:flex-row md:justify-start md:gap-4 md:hover:bg-gray-700" onclick="event.preventDefault(); navigateTo('forum', this)">
                        <i class="fa-solid fa-comments text-lg md:w-6"></i><span class="text-xs mt-1 md:text-base md:mt-0">Forum</span>
                    </a>
                    <a href="#" class="sidebar-link bottom-nav-link flex-shrink-0 w-20 flex flex-col items-center justify-center p-2 text-center text-gray-400 rounded-lg hover:text-white md:w-full md:flex-row md:justify-start md:gap-4 md:hover:bg-gray-700" onclick="event.preventDefault(); navigateTo('pengaturan', this)">
                        <i class="fa-solid fa-user-gear text-lg md:w-6"></i><span class="text-xs mt-1 md:text-base md:mt-0">Pengaturan</span>
                    </a>
                </div>
            </nav>
            <div class="hidden mt-auto md:block">
                <button onclick="logout()" class="w-full bg-red-800 hover:bg-red-700 text-white py-2 px-3 rounded">
                    <i class="fa-solid fa-right-from-bracket"></i><span class="md:inline"> Logout</span>
                </button>
            </div>
        </aside>

        <main id="app-content" class="flex-1 p-4 md:p-6 space-y-6 pb-24 md:pb-6 overflow-x-hidden"></main>
    </div>

    <div id="toast-container" class="fixed top-5 right-5 z-[100] space-y-3 w-80"></div>
    <div id="modal-container" style="display: none;"></div>

    <script>
    // =================================================================================
    // BAGIAN 0: KONFIGURASI DAN DATA MASTER (GLOBAL)
    // =================================================================================
    const CONFIG = {
        API_URL: 'https://script.google.com/macros/s/AKfycbyP3jpWgs6ikQcA-9MsInRZYbLFQsshjxgo22twwXrzpACSPV9BREogrKUd-60crXV_mg/exec',
        LOGIN_PAGE: '../Login/',
        SESSION_KEYS: {
            TOKEN: 'sessionToken',
            EMAIL: 'sessionEmail',
        },
        STORAGE_KEYS: {
            COMPLETED_ITEMS: 'userCompletedItems',
            LAST_SCORE: 'lastQuizScore',
            WELCOME_POPUP: 'welcomePopupShown',
        }
    };
    
    let heartbeatIntervalId = null;
    let currentQuizData = null;
    let currentQuestionIndex = 0;
    let userAnswers = [];
    let currentExplanationIndex = 0;
    
    // =================================================================================
    // BAGIAN 1: LOGIKA SESI & KEAMANAN
    // =================================================================================
    async function verifySession(token, email) {
        try {
            const response = await fetch(CONFIG.API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify({ action: 'check_session', token: token, email: email })
            });
            const result = await response.json();
            if (!result.isValid) {
                forceLogout("Sesi Anda tidak valid atau telah berakhir. Silakan login kembali.");
            }
        } catch (error) {
            console.error("Heartbeat check failed:", error);
            showToast("Gagal terhubung ke server. Memeriksa kembali...", "error");
        }
    }
    
    function startSessionHeartbeat(token, email) {
        if (heartbeatIntervalId) clearInterval(heartbeatIntervalId);
        verifySession(token, email);
        heartbeatIntervalId = setInterval(() => verifySession(token, email), 60000);
    }
    
    function forceLogout(message) {
        if (heartbeatIntervalId) {
            clearInterval(heartbeatIntervalId);
            heartbeatIntervalId = null;
        }
        const onConfirmAction = () => {
            sessionStorage.removeItem(CONFIG.SESSION_KEYS.TOKEN);
            sessionStorage.removeItem(CONFIG.SESSION_KEYS.EMAIL);
            window.location.href = CONFIG.LOGIN_PAGE;
        };
        showConfirmationModal({
            title: 'Sesi Berakhir',
            message: message,
            confirmText: 'OK',
            confirmAction: onConfirmAction,
            showCancelButton: false
        });
    }
    
    function logout() {
        showConfirmationModal({
            title: 'Konfirmasi Logout',
            message: 'Apakah Anda yakin ingin keluar dari sesi Anda?',
            confirmText: 'Logout',
            confirmButtonClass: 'modal-btn-danger',
            confirmAction: () => {
                sessionStorage.removeItem(CONFIG.SESSION_KEYS.TOKEN);
                sessionStorage.removeItem(CONFIG.SESSION_KEYS.EMAIL);
                if (heartbeatIntervalId) {
                    clearInterval(heartbeatIntervalId);
                    heartbeatIntervalId = null;
                }
                window.location.href = CONFIG.LOGIN_PAGE;
            }
        });
    }
    
    // =================================================================================
    // BAGIAN 2: LOGIKA APLIKASI UTAMA (NAVIGASI & RENDER GLOBAL)
    // =================================================================================
    const appContent = document.getElementById('app-content');
    
    const pageRenderers = {
        'dashboard': renderDashboardPage,
        'materi': renderMateriPage,
        'bank_soal': renderBankSoalPage,
        'video': renderVideoPage,
        'forum': renderForumPage,
        'pengaturan': renderPengaturanPage,
    };
    
    function navigateTo(page, clickedElement) {
        document.querySelectorAll('.sidebar-link, .bottom-nav-link').forEach(link => link.classList.remove('active'));
        if (clickedElement) {
            const targetLink = Array.from(document.querySelectorAll('.sidebar-link, .bottom-nav-link'))
                                    .find(a => a.getAttribute('onclick').includes(`'${page}'`));
            if(targetLink) targetLink.classList.add('active');
        }
        
        const renderFunction = pageRenderers[page];
        if (renderFunction) {
            renderFunction();
        } else {
            console.error(`Tidak ada renderer untuk halaman: ${page}`);
            appContent.innerHTML = `<p class="text-center text-red-500">Halaman tidak ditemukan.</p>`;
        }
    }
    
    // =================================================================================
    // BAGIAN 3: FUNGSI RENDER UNTUK SETIAP HALAMAN
    // =================================================================================
    function renderDashboardPage() {
        appContent.innerHTML = `
            <header class="panel flex justify-between items-center">
                <div>
                    <h2 id="user-greeting" class="text-xl font-bold"></h2>
                    <p class="text-sm text-gray-400">Selamat datang di Command Center Anda.</p>
                </div>
            </header>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="col-span-1 lg:col-span-2 space-y-6">
                    <div class="panel">
                        <h4 class="font-bold text-lg mb-4">Status Anda</h4>
                        <div id="status-container" class="space-y-4"></div>
                    </div>
                    <div id="last-score-widget-container"></div>
                </div>
                <div class="col-span-1 space-y-6">
                    <div class="panel">
                        <h4 class="font-bold text-lg mb-4">Pencapaian</h4>
                        <div id="lencana-container" class="flex gap-4"></div>
                    </div>
                     <div class="panel">
                        <h4 class="font-bold text-lg mb-4">Info Terbaru UMT</h4>
                        <div id="social-media-container" class="space-y-4"></div>
                    </div>
                </div>
            </div>
        `;
        initializeAppDashboardWidgets();
    }
    
function renderMateriPage() {
    let accordionHTML = '';
    const materiData = allContentData.materi;

    for (const gradeKey in materiData) {
        // Kita tambahkan data-grade-key agar mudah dicari nanti
        const itemsHTML = materiData[gradeKey].map(item => `
            <li id="card-${item.id}"
                class="card-item-list block p-3 rounded-md hover:bg-gray-700 cursor-pointer"
                data-grade-key="${gradeKey}" 
                onclick="showMateriContent('${item.id}', '${gradeKey}')">
                <span class="font-semibold">${item.title}</span>
                <span class="block text-xs text-gray-400">${item.type}</span>
            </li>
        `).join('');

        // Kita tambahkan ID unik untuk setiap grup accordion
        accordionHTML += `
            <div class="accordion-item border-b border-gray-700" data-accordion-group>
                <h2>
                    <button type="button" class="accordion-button flex items-center justify-between w-full p-4 font-semibold text-left text-cyan-300">
                        <span>${gradeKey}</span>
                        <i class="accordion-icon fa-solid fa-chevron-down shrink-0 transition-transform duration-200"></i>
                    </button>
                </h2>
                <div class="accordion-content hidden p-2">
                    <ul class="space-y-2">${itemsHTML}</ul>
                </div>
            </div>
        `;
    }

    const materiPageHTML = `
        <div class="panel">
            <h2 class="text-2xl font-bold text-cyan-400">Pustaka Materi</h2>
            <p class="text-sm text-gray-400 mb-6">Cari atau pilih jenjang kelas untuk melihat daftar materi.</p>

            <div class="relative mb-6">
                <input type="text" id="materi-search-input"
                       class="w-full bg-gray-900/80 border border-gray-600 rounded-lg py-2 pl-10 pr-4 text-white placeholder-gray-500 focus:ring-2 focus:ring-cyan-500 focus:outline-none"
                       placeholder="Ketik untuk mencari materi...">
                <i class="fa-solid fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-500"></i>
            </div>
            
            <div id="materi-layout-container" class="flex flex-col md:flex-row gap-6">
                <div id="materi-list-container" class="w-full md:w-1/3 lg:w-1/4">
                    <div class="border border-gray-700 rounded-lg bg-gray-900/50">
                        ${accordionHTML}
                    </div>
                </div>
                <div id="materi-viewer-container" class="w-full md:w-2/3 lg:w-3/4 hidden md:flex flex-col">
                    <div id="materi-viewer-content" class="bg-gray-900/50 p-6 rounded-lg border border-gray-700 h-full flex items-center justify-center">
                        <div class="text-center text-gray-500">
                            <i class="fa-solid fa-file-lines fa-2x mb-4"></i>
                            <p>Konten akan ditampilkan di sini.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    appContent.innerHTML = materiPageHTML;

    // Tambahkan event listener untuk accordion
    document.querySelectorAll('.accordion-button').forEach(button => {
        button.addEventListener('click', () => {
            const content = button.parentElement.nextElementSibling;
            const icon = button.querySelector('.accordion-icon');
            content.classList.toggle('hidden');
            icon.classList.toggle('rotate-180');
        });
    });

    // [KODE BARU] Panggil fungsi untuk mengaktifkan logika pencarian
    setupMateriSearch();
}

function setupMateriSearch() {
    const searchInput = document.getElementById('materi-search-input');
    if (!searchInput) return;

    searchInput.addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase().trim();
        const allMateriItems = document.querySelectorAll('.card-item-list');
        const allAccordionGroups = document.querySelectorAll('[data-accordion-group]');

        // Jika kotak pencarian kosong, kembalikan ke tampilan semula
        if (searchTerm === '') {
            allMateriItems.forEach(item => {
                item.style.display = 'block';
            });
            allAccordionGroups.forEach(group => {
                group.style.display = 'block';
                // Tutup semua accordion
                group.querySelector('.accordion-content').classList.add('hidden');
                group.querySelector('.accordion-icon').classList.remove('rotate-180');
            });
            return;
        }

        // Proses pencarian
        allAccordionGroups.forEach(group => {
            const itemsInGroup = group.querySelectorAll('.card-item-list');
            let hasVisibleItemInGroup = false;

            itemsInGroup.forEach(item => {
                const title = item.querySelector('.font-semibold').textContent.toLowerCase();
                if (title.includes(searchTerm)) {
                    item.style.display = 'block';
                    hasVisibleItemInGroup = true;
                } else {
                    item.style.display = 'none';
                }
            });

            // Tampilkan atau sembunyikan seluruh grup kelas
            if (hasVisibleItemInGroup) {
                group.style.display = 'block';
                // Buka accordion yang relevan secara otomatis
                group.querySelector('.accordion-content').classList.remove('hidden');
                group.querySelector('.accordion-icon').classList.add('rotate-180');
            } else {
                group.style.display = 'none';
            }
        });
    });
}
    
function showConfirmationModal(options) {
    const {
        title,
        message,
        confirmText = 'Konfirmasi',
        cancelText = 'Batal',
        confirmAction,
        cancelAction,
        showCancelButton = true,
        confirmButtonClass = 'modal-btn-confirm',
        customModalClass = ''
    } = options;

    const modalContainer = document.getElementById('modal-container');
    
    const modalHTML = `
        <div class="modal-overlay" id="modal-overlay">
            <div class="modal-box ${customModalClass}"> 
                <h3 class="modal-title">${title}</h3>
                
                <div class="modal-content">${message}</div>
                
                <div class="modal-buttons">
                    ${showCancelButton ? `<button id="modal-cancel-btn" class="modal-btn modal-btn-cancel">${cancelText}</button>` : ''}
                    <button id="modal-confirm-btn" class="modal-btn ${confirmButtonClass}">${confirmText}</button>
                </div>
            </div>
        </div>
    `;

    modalContainer.innerHTML = modalHTML;
    modalContainer.style.display = 'block';

    const closeModal = () => {
        modalContainer.style.display = 'none';
        modalContainer.innerHTML = '';
    };

    document.getElementById('modal-confirm-btn').addEventListener('click', () => {
        if (typeof confirmAction === 'function') confirmAction();
        closeModal();
    });

    if (showCancelButton) {
        const cancelBtn = document.getElementById('modal-cancel-btn');
        cancelBtn.addEventListener('click', () => {
            if (typeof cancelAction === 'function') cancelAction();
            closeModal();
        });
        document.getElementById('modal-overlay').addEventListener('click', (event) => {
             if (event.target === event.currentTarget) {
                if (typeof cancelAction === 'function') cancelAction();
                closeModal();
             }
        });
    }
}
    
    function goBackToList() {
        document.getElementById('materi-list-container').classList.remove('hidden');
        document.getElementById('materi-viewer-container').classList.add('hidden');
    }
    
function renderVideoPage() {
    // [BARU] Mengambil kategori unik dari data video secara dinamis
    const categories = ['Semua', ...new Set(allContentData.video.map(item => item.category))];

    // [BARU] Membuat tombol-tombol filter dari kategori yang ada
    const filterButtonsHTML = categories.map(category => `
        <button class="filter-btn text-sm py-2 px-4 rounded-full bg-gray-700 hover:bg-cyan-600 transition-colors" data-filter="${category}">
            ${category}
        </button>
    `).join('');

    // [DIUBAH] Membuat kartu video dengan menambahkan atribut data-category
    const videoHTML = allContentData.video.map(item => `
        <div class="video-card card-item p-4 rounded-lg flex flex-col" data-category="${item.category}" onclick="playVideoInModal('${item.videoId}', '${item.title}')">
            <img src="https://img.youtube.com/vi/${item.videoId}/mqdefault.jpg" alt="${item.title}" class="rounded-md mb-3">
            <h3 class="font-bold text-base mb-2 flex-grow">${item.title}</h3>
            <div class="text-xs font-mono text-cyan-300 flex items-center gap-2">
                <i class="fa-brands fa-youtube text-red-500"></i> YouTube Video
            </div>
        </div>
    `).join('');

    appContent.innerHTML = `
        <div class="panel">
            <h2 class="text-2xl font-bold text-cyan-400">Video Pembelajaran</h2>
            <p class="text-sm text-gray-400 mb-6">Pilih kategori atau tonton video pilihan untuk pemahaman lebih dalam.</p>
            
            <div class="mb-8 flex flex-wrap gap-2" id="video-filter-container">
                ${filterButtonsHTML}
            </div>

            <div id="video-grid-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                ${videoHTML}
            </div>
        </div>
    `;

    // [BARU] Panggil fungsi untuk mengaktifkan logika filter
    setupVideoFilter();
}

// [FUNGSI BARU] Letakkan ini di dalam <script> Anda
function playVideoInModal(videoId, title) {
    const videoPlayerHTML = `
        <div class="video-responsive-container">
            <iframe
                src="https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0"
                frameborder="0"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                allowfullscreen>
            </iframe>
        </div>
    `;

    showConfirmationModal({
        title: title,
        message: videoPlayerHTML,
        confirmText: 'Tutup',
        showCancelButton: false,
        confirmButtonClass: 'modal-btn-confirm mt-4 w-full justify-center',
        customModalClass: 'video-modal-box'
    });
}

function setupVideoFilter() {
    const filterContainer = document.getElementById('video-filter-container');
    const videoCards = document.querySelectorAll('.video-card');
    if (!filterContainer) return;

    // Set tombol 'Semua' sebagai aktif secara default
    filterContainer.querySelector('[data-filter="Semua"]').classList.add('bg-cyan-600');

    filterContainer.addEventListener('click', (e) => {
        if (!e.target.matches('.filter-btn')) return;

        const selectedFilter = e.target.dataset.filter;

        // Atur tampilan tombol aktif
        document.querySelectorAll('#video-filter-container .filter-btn').forEach(btn => {
            btn.classList.remove('bg-cyan-600');
        });
        e.target.classList.add('bg-cyan-600');

        // Proses filter untuk setiap kartu video
        videoCards.forEach(card => {
            if (selectedFilter === 'Semua' || card.dataset.category === selectedFilter) {
                card.style.display = 'flex'; // Gunakan flex karena kartu kita adalah flex column
            } else {
                card.style.display = 'none';
            }
        });
    });
}
    
function renderBankSoalPage() {
    const categories = ['Semua', ...new Set(allContentData.bankSoal.map(quiz => quiz.category || 'Lainnya'))];

    // Membuat Tombol Filter
    const filterButtonsHTML = categories.map(category => `
        <button class="filter-btn text-sm py-2 px-4 rounded-full bg-gray-700 hover:bg-cyan-600 transition-colors" data-filter="${category}">
            ${category}
        </button>
    `).join('');

    // Membuat Kartu Soal
    const categoriesHTML = allContentData.bankSoal.reduce((acc, quiz) => {
        const category = quiz.category || 'Lainnya';
        if (!acc[category]) {
            acc[category] = [];
        }
        acc[category].push(quiz);
        return acc;
    }, {});

    let quizSectionsHTML = '';
    for (const category in categoriesHTML) {
        const quizzes = categoriesHTML[category];
        const cardsHTML = quizzes.map(quiz => `
            <div class="card-item p-6 rounded-lg flex flex-col flex-shrink-0 w-72 md:w-80" onclick="startQuiz('${quiz.id}')">
                <h3 class="font-bold text-lg mb-2">${quiz.title}</h3>
                <p class="text-sm text-gray-400 mb-4">${quiz.subject}</p>
                <div class="mt-auto text-xs font-mono bg-gray-900/50 text-cyan-300 rounded-full px-3 py-1 self-start">
                    ${quiz.totalQuestions} Soal
                </div>
            </div>
        `).join('');

        // Menambahkan atribut data-category untuk identifikasi
        quizSectionsHTML += `
            <div class="quiz-category-section mb-8" data-category="${category}">
                <h3 class="text-xl font-bold mb-4 text-cyan-300">${category}</h3>
                <div class="no-scrollbar flex overflow-x-auto gap-4 pb-4">
                    ${cardsHTML}
                </div>
            </div>
        `;
    }
    
    // Menggabungkan semuanya
    const bankSoalHTML = `
        <div class="panel">
            <h2 class="text-2xl font-bold mb-1 text-cyan-400">Bank Soal</h2>
            <p class="text-sm text-gray-400 mb-6">Pilih paket soal untuk mulai berlatih.</p>
            
            <div class="mb-8 flex flex-wrap gap-2" id="filter-container">
                ${filterButtonsHTML}
            </div>

            <div id="quiz-list-container">
                ${quizSectionsHTML}
            </div>
        </div>
    `;
    appContent.innerHTML = bankSoalHTML;

    // Panggil fungsi untuk mengaktifkan logika filter
    setupBankSoalFilter();
}

function setupBankSoalFilter() {
    const filterContainer = document.getElementById('filter-container');
    const quizSections = document.querySelectorAll('.quiz-category-section');
    if (!filterContainer) return;

    // Set tombol 'Semua' sebagai aktif secara default
    filterContainer.querySelector('[data-filter="Semua"]').classList.add('bg-cyan-600');

    filterContainer.addEventListener('click', (e) => {
        // Hanya proses jika yang diklik adalah tombol filter
        if (!e.target.matches('.filter-btn')) return;

        const selectedFilter = e.target.dataset.filter;

        // Atur tampilan tombol aktif
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.classList.remove('bg-cyan-600');
        });
        e.target.classList.add('bg-cyan-600');

        // Proses filter untuk setiap bagian soal
        quizSections.forEach(section => {
            if (selectedFilter === 'Semua' || section.dataset.category === selectedFilter) {
                section.style.display = 'block';
            } else {
                section.style.display = 'none';
            }
        });
    });
}
    
    function renderForumPage() {
        appContent.innerHTML = `<div class="forum-container"><div class="intro"><h1>Forum Belajar UMT</h1><p>Bergabunglah dengan komunitas eksklusif UMT Academy! Tempat terbaik untuk berdiskusi, bertanya, berbagi ilmu, dan menguasai matematika bersama sesama pelajar dan fasilitator.</p></div><div class="community-links"><h2>Pilih Komunitas Pilihanmu Sekarang!</h2><div class="flex justify-center gap-4 flex-wrap"><a href="https://chat.whatsapp.com/GpyKRFFjMINBcjqGEYSXQ6" target="_blank" class="community-btn whatsapp-btn"><i class="fab fa-whatsapp"></i><span>Komunitas WhatsApp</span></a><a href="https://t.me/umt6174" target="_blank" class="community-btn telegram-btn"><i class="fab fa-telegram"></i><span>Komunitas Telegram</span></a></div><p class="subtext">Bergabunglah dengan ribuan pelajar lainnya!</p></div></div>`;
    }
    
    function renderPengaturanPage() {
        appContent.innerHTML = `
        <div class="panel max-w-2xl mx-auto">
            <h2 class="text-2xl font-bold mb-1 text-cyan-400">Pengaturan</h2>
            <p class="text-sm text-gray-400 mb-6">Kelola data aplikasi dan akun Anda di sini.</p>
            <div class="space-y-4">
                <div class="bg-gray-900/50 p-4 rounded-lg flex items-center justify-between flex-wrap gap-3">
                    <div>
                        <h4 class="font-bold">Reset Progres Belajar</h4>
                        <p class="text-xs text-gray-400 mt-1">Aksi ini akan menghapus semua progres dan lencana Anda.</p>
                    </div>
                    <button onclick="resetProgress()" class="bg-red-800 hover:bg-red-700 text-white text-sm font-bold py-2 px-4 rounded-lg flex-shrink-0">Reset Data</button>
                </div>
                <div class="bg-gray-900/50 p-4 rounded-lg flex items-center justify-between flex-wrap gap-3">
                    <div>
                        <h4 class="font-bold">Akun</h4>
                        <p class="text-xs text-gray-400 mt-1">Keluar dari akun Anda pada perangkat ini.</p>
                    </div>
                    <button onclick="logout()" class="w-full sm:w-auto bg-red-800 hover:bg-red-700 text-white text-sm font-bold py-2 px-4 rounded-lg flex-shrink-0">
                        <i class="fa-solid fa-right-from-bracket"></i> Logout
                    </button>
                </div>
            </div>
        </div>`;
    }
    
    // =================================================================================
    // BAGIAN 4: LOGIKA WIDGET DASBOR & PROGRES
    // =================================================================================
    function getTotalItemCount() {
        const totalMateri = Object.values(allContentData.materi).reduce((sum, grade) => sum + grade.length, 0);
        const totalVideo = allContentData.video.length;
        const totalBankSoal = allContentData.bankSoal.length;
        return totalMateri + totalVideo + totalBankSoal;
    }
    
    function initializeAppDashboardWidgets() {
        const email = sessionStorage.getItem(CONFIG.SESSION_KEYS.EMAIL) || 'pengguna@email.com';
        const namePart = email.split('@')[0];
        document.getElementById('user-greeting').innerHTML = `Halo, ${namePart.charAt(0).toUpperCase() + namePart.slice(1)} ðŸ‘‹`;
        
        const completedItems = JSON.parse(localStorage.getItem(CONFIG.STORAGE_KEYS.COMPLETED_ITEMS)) || [];
        const totalItems = getTotalItemCount(); 
        const progress = totalItems > 0 ? Math.round((completedItems.length / totalItems) * 100) : 0;
        
        document.getElementById('status-container').innerHTML = `<div><span class="text-sm">ðŸ“š Progress Keseluruhan (${completedItems.length}/${totalItems})</span><div class="w-full bg-gray-700 rounded-full h-2.5 mt-1"><div class="bg-cyan-500 h-2.5 rounded-full transition-all duration-500" style="width: ${progress}%"></div></div></div>`;
        
        let lencanaHTML = '';
        if (completedItems.length >= 1) lencanaHTML += `<div title="Langkah Pertama"><i class="fa-solid fa-shoe-prints text-cyan-400 text-2xl"></i></div>`;
        if (progress >= 50) lencanaHTML += `<div title="Setengah Jalan!"><i class="fa-solid fa-road-circle-check text-green-400 text-2xl"></i></div>`;
        if (progress === 100) lencanaHTML += `<div title="100% Selesai!"><i class="fa-solid fa-trophy text-amber-400 text-2xl"></i></div>`;
        document.getElementById('lencana-container').innerHTML = lencanaHTML || `<p class="text-sm text-gray-500">Selesaikan materi untuk dapat lencana!</p>`;
    
        document.getElementById('social-media-container').innerHTML = socialMediaUpdates.map(item => `
            <a href="${item.link}" target="_blank" class="flex items-start gap-3 p-2 rounded-lg hover:bg-gray-800">
                ${item.icon.endsWith('.png') ? `<img src="${item.icon}" class="w-6 h-6">` : `<i class="${item.icon} ${item.color} text-xl w-6 text-center"></i>`}
                <span class="text-sm text-gray-300">${item.text}</span>
            </a>
        `).join('');
    
        const lastScoreContainer = document.getElementById('last-score-widget-container');
        const lastScoreData = JSON.parse(localStorage.getItem(CONFIG.STORAGE_KEYS.LAST_SCORE));
        if (lastScoreData) {
            lastScoreContainer.innerHTML = `
                <div class="panel">
                    <h4 class="font-bold text-lg mb-4">Skor Kuis Terakhir</h4>
                    <div class="text-center">
                        <p class="text-sm text-gray-400">${lastScoreData.title}</p>
                        <p class="text-4xl font-bold text-cyan-400 mt-2">${lastScoreData.percentage}%</p>
                        <p class="text-gray-300 mt-1 text-xs">(${lastScoreData.score} dari ${lastScoreData.total} soal benar)</p>
                    </div>
                </div>`;
        }
    }
    
    function resetProgress() {
        showConfirmationModal({
            title: 'Konfirmasi Reset Progres',
            message: 'Apakah Anda yakin ingin mereset semua progres belajar Anda? Aksi ini tidak dapat dibatalkan.',
            confirmText: 'Ya, Reset',
            confirmButtonClass: 'modal-btn-danger',
            confirmAction: () => {
                localStorage.removeItem(CONFIG.STORAGE_KEYS.COMPLETED_ITEMS);
                localStorage.removeItem(CONFIG.STORAGE_KEYS.LAST_SCORE);
                showToast("Progres belajar berhasil direset.", "success");
                navigateTo('dashboard', null);
            },
            cancelAction: () => showToast("Aksi reset dibatalkan.", "info")
        });
    }
    
    function markAsCompleted(itemId, options = { showToast: false }) {
        let completed = JSON.parse(localStorage.getItem(CONFIG.STORAGE_KEYS.COMPLETED_ITEMS)) || [];
        if (!completed.includes(itemId)) {
            completed.push(itemId);
            localStorage.setItem(CONFIG.STORAGE_KEYS.COMPLETED_ITEMS, JSON.stringify(completed));
            if (options.showToast) {
                showToast("Progres telah dicatat!", "success");
            }
        }
    }
    
    // =================================================================================
    // BAGIAN 5: LOGIKA KUIS
    // =================================================================================
    function startQuiz(quizId) {
        currentQuizData = allContentData.bankSoal.find(q => q.id === quizId);
        if (!currentQuizData) { showToast('Kuis tidak ditemukan!', 'error'); return; }
        currentQuestionIndex = 0;
        userAnswers = new Array(currentQuizData.questions.length).fill(null);
        renderQuizInterface();
    }
    
    function renderQuizInterface() {
        const quiz = currentQuizData;
        const question = quiz.questions[currentQuestionIndex];
        const quizHTML = `<div class="panel max-w-4xl mx-auto"><div class="flex justify-between items-start mb-4"><div><h2 class="text-xl font-bold text-cyan-400">${quiz.title}</h2><p class="text-sm text-gray-400">Pertanyaan ${currentQuestionIndex + 1} dari ${quiz.questions.length}</p></div><button onclick="navigateTo('bank_soal', null)" class="text-xs text-gray-400 hover:text-white">Ã— Tutup</button></div><hr class="border-gray-700 my-4"/><div class="mb-6 min-h-[60px]"><div class="text-lg text-gray-200">${question.questionText}</div></div><div id="quiz-options" class="space-y-3">${question.options.map((opt, index) => `<div id="option-${index}" class="quiz-option p-4 rounded-lg cursor-pointer transition-colors" onclick="selectAnswer('${opt.replace(/'/g, "\\'")}', ${index})">${opt}</div>`).join('')}</div><hr class="border-gray-700 my-6"/><div class="flex justify-end"><button id="next-btn" onclick="submitQuiz()" class="bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-2 px-6 rounded-lg">${currentQuestionIndex === quiz.questions.length - 1 ? 'Selesai & Lihat Hasil' : 'Lanjut'}</button></div></div>`;
        appContent.innerHTML = quizHTML;
        if (window.MathJax) { MathJax.typeset(); }
    }
    
    function selectAnswer(answer, optionIndex) {
        userAnswers[currentQuestionIndex] = answer;
        document.querySelectorAll('.quiz-option').forEach(el => el.classList.remove('selected'));
        document.getElementById(`option-${optionIndex}`).classList.add('selected');
    }
    
    function submitQuiz() {
        if (userAnswers[currentQuestionIndex] === null) { showToast('Silakan pilih jawaban terlebih dahulu!', 'error'); return; }
        if (currentQuestionIndex < currentQuizData.questions.length - 1) { currentQuestionIndex++; renderQuizInterface(); } else { renderQuizResults(); }
    }
    
    function renderQuizResults() {
        const quiz = currentQuizData;
        let score = 0;
        quiz.questions.forEach((q, index) => { if (q.correctAnswer === userAnswers[index]) { score++; } });
        
        markAsCompleted(quiz.id);
    
        const finalScorePercentage = quiz.questions.length > 0 ? Math.round((score / quiz.questions.length) * 100) : 0;
        localStorage.setItem(CONFIG.STORAGE_KEYS.LAST_SCORE, JSON.stringify({
            title: quiz.title,
            score: score,
            total: quiz.questions.length,
            percentage: finalScorePercentage
        }));
        
        appContent.innerHTML = `
        <div class="max-w-4xl mx-auto">
            <h2 class="text-2xl font-bold text-center mb-2 text-white">${quiz.title}</h2>
            <p class="text-center text-sm text-gray-400 mb-6">Berikut adalah pembahasan dari latihan yang kamu kerjakan.</p>
            <div class="text-center my-6 bg-gray-900/50 p-4 rounded-lg border border-gray-700">
                 <p class="text-gray-400">Skor Akhir Anda</p>
                 <p class="text-5xl font-bold text-cyan-400 mt-2">${finalScorePercentage}%</p>
                 <p class="text-gray-300 mt-2">(${score} dari ${quiz.questions.length} soal benar)</p>
            </div>
            <div id="single-explanation-container" class="space-y-4"></div>
            <div class="flex justify-between items-center mt-8 quiz-nav-buttons">
                <button id="prev-explanation-btn" onclick="prevExplanation()" class="nav-btn bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2">
                    <i class="fa-solid fa-chevron-left"></i> Sebelumnya
                </button>
                <button onclick="navigateTo('bank_soal', null)" class="bg-cyan-800 hover:bg-cyan-700 text-white text-sm py-2 px-4 rounded-lg">
                    Kembali ke Bank Soal
                </button>
                <button id="next-explanation-btn" onclick="nextExplanation()" class="nav-btn bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2">
                    Selanjutnya <i class="fa-solid fa-chevron-right"></i>
                </button>
            </div>
        </div>`;
    
        currentExplanationIndex = 0;
        renderSingleExplanation(currentExplanationIndex);
    }
    
    function renderSingleExplanation(index) {
        const container = document.getElementById('single-explanation-container');
        const quiz = currentQuizData;
        const q = quiz.questions[index];
    
        container.innerHTML = `
        <div class="panel">
            <p class="text-sm text-gray-400 mb-4">Pertanyaan ${index + 1} dari ${quiz.questions.length}</p>
            <div class="mb-5 text-gray-200 text-lg">${q.questionText}</div>
            <div class="space-y-3 text-base">
                <p class="${userAnswers[index] === q.correctAnswer ? 'correct-answer' : 'wrong-answer'} p-3 rounded-lg">
                    <span class="font-bold block">Jawaban Anda:</span>
                    ${userAnswers[index] || 'Tidak dijawab'}
                </p>
                <p class="correct-answer p-3 rounded-lg">
                    <span class="font-bold block">Jawaban Benar:</span>
                    ${q.correctAnswer}
                </p>
            </div>
            <hr class="border-gray-700 my-5"/>
            <div>
                <h4 class="font-bold text-lg text-cyan-300 mb-2">Pembahasan:</h4>
                <div class="text-gray-300 leading-relaxed">${q.explanation}</div>
            </div>
        </div>`;
        
        document.getElementById('prev-explanation-btn').disabled = (index === 0);
        document.getElementById('next-explanation-btn').disabled = (index === quiz.questions.length - 1);
        
        if (window.MathJax) {
            MathJax.typesetPromise([container]).catch(err => console.log('MathJax error: ', err.message));
        }
    }
    
    function nextExplanation() { if (currentExplanationIndex < currentQuizData.questions.length - 1) { currentExplanationIndex++; renderSingleExplanation(currentExplanationIndex); } }
    function prevExplanation() { if (currentExplanationIndex > 0) { currentExplanationIndex--; renderSingleExplanation(currentExplanationIndex); } }
    
    // =================================================================================
    // BAGIAN 6: FUNGSI UTILITAS GLOBAL
    // =================================================================================
    function showToast(message, type = 'info') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        const icons = { info: 'fa-solid fa-circle-info', success: 'fa-solid fa-check-circle', error: 'fa-solid fa-triangle-exclamation' };
        const colors = { info: 'text-cyan-400', success: 'text-green-400', error: 'text-red-400' };
        toast.className = 'toast-in flex items-start p-4 rounded-lg shadow-lg text-sm';
        toast.style.backgroundColor = 'var(--bg-panel)';
        toast.style.border = '1px solid var(--border-color)';
        toast.innerHTML = `<div class="flex-shrink-0"><i class="${icons[type] || icons['info']} ${colors[type] || colors['info']} text-xl"></i></div><div class="ml-3"><p class="font-bold capitalize ${colors[type] || colors['info']}">${type}</p><p class="text-gray-300 mt-1">${message}</p></div>`;
        container.appendChild(toast);
        setTimeout(() => {
            toast.classList.remove('toast-in');
            toast.classList.add('toast-out');
            toast.addEventListener('animationend', () => toast.remove());
        }, 5000);
    }
    
function showConfirmationModal(options) {
    const {
        title,
        message,
        confirmText = 'Konfirmasi',
        cancelText = 'Batal',
        confirmAction,
        cancelAction,
        showCancelButton = true,
        confirmButtonClass = 'modal-btn-confirm',
        customModalClass = '' // <-- Pastikan baris ini ada
    } = options;

    const modalContainer = document.getElementById('modal-container');
    
    // Pastikan class kustom ditambahkan dengan benar di sini
    const modalHTML = `
        <div class="modal-overlay" id="modal-overlay">
            <div class="modal-box ${customModalClass}"> 
                <h3 class="modal-title">${title}</h3>
                <div class="modal-content">${message}</div>
                <div class="modal-buttons">
                    ${showCancelButton ? `<button id="modal-cancel-btn" class="modal-btn modal-btn-cancel">${cancelText}</button>` : ''}
                    <button id="modal-confirm-btn" class="modal-btn ${confirmButtonClass}">${confirmText}</button>
                </div>
            </div>
        </div>
    `;

    modalContainer.innerHTML = modalHTML;
    modalContainer.style.display = 'block';

    const closeModal = () => {
        modalContainer.style.display = 'none';
        modalContainer.innerHTML = '';
    };

    document.getElementById('modal-confirm-btn').addEventListener('click', () => {
        if (typeof confirmAction === 'function') confirmAction();
        closeModal();
    });

    if (showCancelButton) {
        const cancelBtn = document.getElementById('modal-cancel-btn');
        cancelBtn.addEventListener('click', () => {
            if (typeof cancelAction === 'function') cancelAction();
            closeModal();
        });
        document.getElementById('modal-overlay').addEventListener('click', (event) => {
             if (event.target === event.currentTarget) {
                if (typeof cancelAction === 'function') cancelAction();
                closeModal();
             }
        });
    }
}
    
    // =================================================================================
    // BAGIAN 7: INISIALISASI APLIKASI
    // =================================================================================
    function initializeApp() {
        const token = sessionStorage.getItem(CONFIG.SESSION_KEYS.TOKEN);
        const email = sessionStorage.getItem(CONFIG.SESSION_KEYS.EMAIL);
    
        if (!token || !email) {
            window.location.href = CONFIG.LOGIN_PAGE;
            return;
        }
        
        startSessionHeartbeat(token, email);
    
        navigateTo('dashboard', document.querySelector('.sidebar-link'));
    
        if (!sessionStorage.getItem(CONFIG.STORAGE_KEYS.WELCOME_POPUP)) {
            showConfirmationModal({
                title: 'ðŸŽ‰ Selamat Datang di UMT Pro!',
                message: 'Mohon maaf, halaman untuk Member Pro saat ini masih dalam tahap pengembangan aktif. Untuk sekarang, kami memberikan akses penuh hanya untuk bagian halaman "Bank Soal" untuk Anda jelajahi. Terima kasih atas pengertiannya!',
                confirmText: 'Mengerti',
                showCancelButton: false,
                confirmAction: () => sessionStorage.setItem(CONFIG.STORAGE_KEYS.WELCOME_POPUP, 'true')
            });
        }
    }
    
    document.addEventListener('DOMContentLoaded', initializeApp);
    </script>

</body>
</html>
