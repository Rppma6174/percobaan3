<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>UMT Pro Command Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;600&family=Inter:wght@400;600;700&display=swap');
        :root {
            --bg-main: #0D1117; --bg-panel: #161B22; --border-color: #30363D;
            --text-primary: #C9D1D9; --text-secondary: #8B949E; --accent-cyan: #2F81F7;
            --accent-green: #39D353; --accent-red: #F85149;
        }
        body { background-color: var(--bg-main); color: var(--text-primary); font-family: 'Inter', sans-serif; }
        .font-mono { font-family: 'Fira Code', monospace; }
        .panel { background-color: var(--bg-panel); border: 1px solid var(--border-color); border-radius: 0.75rem; padding: 1.5rem; }
        .bottom-nav-link.active { color: var(--accent-cyan); }
        .sidebar-link.active { background-color: #30363D; color: white; }
        .card-item { background-color: #21262D; transition: transform 0.2s; cursor: pointer; }
        .card-item:hover { transform: translateY(-4px); background-color: #30363D; }
        .quiz-option { border: 2px solid var(--border-color); }
        .quiz-option:hover { border-color: var(--accent-cyan); }
        .quiz-option.selected { border-color: var(--accent-cyan); background-color: rgba(47, 129, 247, 0.2); }
        .correct-answer { background-color: rgba(57, 211, 83, 0.1); border-left: 4px solid var(--accent-green); }
        .wrong-answer { background-color: rgba(248, 81, 73, 0.1); border-left: 4px solid var(--accent-red); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .nav-btn:disabled { background-color: #30363D; color: #8B949E; cursor: not-allowed; }

        @keyframes slideInRight { from { opacity: 0; transform: translateX(100%); } to { opacity: 1; transform: translateX(0); } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; transform: translateY(-20px); } }
        .toast-in { animation: slideInRight 0.5s forwards; }
        .toast-out { animation: fadeOut 0.5s forwards; }
    </style>
</head>
<body class="text-white">

    <div class="flex min-h-screen">
        <aside class="fixed bottom-0 left-0 z-50 w-full h-16 bg-[var(--bg-panel)] border-t border-[var(--border-color)] 
                       md:relative md:w-64 md:h-screen md:flex md:flex-col md:border-t-0 md:border-r md:p-6">
            
            <h1 class="hidden text-xl font-bold mb-10 text-cyan-400 md:block md:text-2xl">UMT Pro</h1>
            
            <nav id="sidebar-nav" class="no-scrollbar flex overflow-x-auto h-full md:flex-col md:space-y-4 md:h-auto">
                <div class="flex flex-nowrap items-center justify-start gap-2 px-2 md:flex-col md:items-stretch md:gap-0 md:px-0">
                    <a href="#" class="sidebar-link bottom-nav-link flex-shrink-0 w-20 flex flex-col items-center justify-center p-2 text-center text-gray-400 rounded-lg hover:text-white md:w-full md:flex-row md:justify-start md:gap-4 md:hover:bg-gray-700" onclick="event.preventDefault(); navigateTo('dashboard', this)">
                        <i class="fa-solid fa-chart-pie text-lg md:w-6"></i><span class="text-xs mt-1 md:text-base md:mt-0">Dashboard</span>
                    </a>
                    <a href="#" class="sidebar-link bottom-nav-link flex-shrink-0 w-20 flex flex-col items-center justify-center p-2 text-center text-gray-400 rounded-lg hover:text-white md:w-full md:flex-row md:justify-start md:gap-4 md:hover:bg-gray-700" onclick="event.preventDefault(); navigateTo('materi', this)">
                        <i class="fa-solid fa-book text-lg md:w-6"></i><span class="text-xs mt-1 md:text-base md:mt-0">Materi</span>
                    </a>
                    <a href="#" class="sidebar-link bottom-nav-link flex-shrink-0 w-20 flex flex-col items-center justify-center p-2 text-center text-gray-400 rounded-lg hover:text-white md:w-full md:flex-row md:justify-start md:gap-4 md:hover:bg-gray-700" onclick="event.preventDefault(); navigateTo('bank_soal', this)">
                        <i class="fa-solid fa-list-check text-lg md:w-6"></i><span class="text-xs mt-1 md:text-base md:mt-0">Bank Soal</span>
                    </a>
                    <a href="#" class="sidebar-link bottom-nav-link flex-shrink-0 w-20 flex flex-col items-center justify-center p-2 text-center text-gray-400 rounded-lg hover:text-white md:w-full md:flex-row md:justify-start md:gap-4 md:hover:bg-gray-700" onclick="event.preventDefault(); navigateTo('video', this)">
                        <i class="fa-solid fa-video text-lg md:w-6"></i><span class="text-xs mt-1 md:text-base md:mt-0">Video</span>
                    </a>
                    <a href="#" class="sidebar-link bottom-nav-link flex-shrink-0 w-20 flex flex-col items-center justify-center p-2 text-center text-gray-400 rounded-lg hover:text-white md:w-full md:flex-row md:justify-start md:gap-4 md:hover:bg-gray-700" onclick="event.preventDefault(); navigateTo('forum', this)">
                        <i class="fa-solid fa-comments text-lg md:w-6"></i><span class="text-xs mt-1 md:text-base md:mt-0">Forum</span>
                    </a>
                    <a href="#" class="sidebar-link bottom-nav-link flex-shrink-0 w-20 flex flex-col items-center justify-center p-2 text-center text-gray-400 rounded-lg hover:text-white md:w-full md:flex-row md:justify-start md:gap-4 md:hover:bg-gray-700" onclick="event.preventDefault(); navigateTo('pengaturan', this)">
                        <i class="fa-solid fa-user-gear text-lg md:w-6"></i><span class="text-xs mt-1 md:text-base md:mt-0">Pengaturan</span>
                    </a>
                </div>
            </nav>
            <div class="hidden mt-auto md:block">
                <button onclick="logout()" class="w-full bg-red-800 hover:bg-red-700 text-white py-2 px-3 rounded">
                    <i class="fa-solid fa-right-from-bracket"></i><span class="md:inline"> Logout</span>
                </button>
            </div>
        </aside>

        <main id="app-content" class="flex-1 p-6 space-y-6 pb-20 md:pb-6"></main>
    </div>

    <div id="toast-container" class="fixed top-5 right-5 z-[100] space-y-3 w-80"></div>

<script>
// =================================================================================
// BAGIAN 0: KONFIGURASI DAN DATA MASTER (GLOBAL)
// =================================================================================
// Hanya data yang benar-benar global yang disimpan di sini
const masterContentList = [
    { id: 'materi_1', title: 'Materi Aljabar', type: 'Materi' },
    { id: 'materi_2', title: 'Materi Kalkulus', type: 'Materi' },
    { id: 'video_1', title: 'Video Pembahasan Vektor', type: 'Video' },
];

// =================================================================================
// BAGIAN 1: LOGIKA SESI & KEAMANAN (GLOBAL)
// =================================================================================
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyP3jpWgs6ikQcA-9MsInRZYbLFQsshjxgo22twwXrzpACSPV9BREogrKUd-60crXV_mg/exec';
const LOGIN_PAGE_URL = '../Login/index.html';
let heartbeatIntervalId = null;
function startSessionHeartbeat(token, email) { if (heartbeatIntervalId) clearInterval(heartbeatIntervalId); verifySession(token, email); heartbeatIntervalId = setInterval(() => verifySession(token, email), 15000); }
async function verifySession(token, email) { try { await fetch(WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'check_session', token: token, email: email }) }); } catch (error) { console.error("Heartbeat check failed:", error); } }
function logout() { sessionStorage.removeItem('sessionToken'); sessionStorage.removeItem('sessionEmail'); if (heartbeatIntervalId) clearInterval(heartbeatIntervalId); showToast("Anda telah berhasil logout.", "success"); setTimeout(() => { window.location.href = LOGIN_PAGE_URL; }, 1500); }
function forceLogout(message) { if (heartbeatIntervalId) clearInterval(heartbeatIntervalId); showToast(message, 'error'); setTimeout(() => { window.location.href = LOGIN_PAGE_URL; }, 2000); }
(function gatekeeper() { const token = sessionStorage.getItem('sessionToken'); const email = sessionStorage.getItem('sessionEmail'); if (!token || !email) { window.location.href = LOGIN_PAGE_URL; return; } startSessionHeartbeat(token, email); document.addEventListener('DOMContentLoaded', () => initializeApp()); })();

// =================================================================================
// BAGIAN 2: LOGIKA APLIKASI UTAMA (NAVIGASI & RENDER GLOBAL)
// =================================================================================
const appContent = document.getElementById('app-content');

function navigateTo(page, clickedElement) {
    document.querySelectorAll('.sidebar-link, .bottom-nav-link').forEach(link => link.classList.remove('active'));
    if (clickedElement) clickedElement.classList.add('active');

    if (page === 'dashboard') {
        renderDashboardPage();
    } else {
        // Semua halaman lain (termasuk bank_soal) akan dimuat dari file eksternal
        fetchAndRenderPage(page);
    }
}

async function fetchAndRenderPage(pageName) {
    appContent.innerHTML = `<p class="text-center text-gray-400">Memuat...</p>`;
    try {
        // 1. Muat konten HTML halaman
        const htmlResponse = await fetch(`halaman/${pageName}.html`);
        if (!htmlResponse.ok) throw new Error(`Halaman HTML tidak ditemukan`);
        const html = await htmlResponse.text();
        appContent.innerHTML = html;

        // 2. Hapus skrip lama (jika ada) untuk mencegah penumpukan
        const oldScript = document.getElementById('page-specific-script');
        if (oldScript) {
            oldScript.remove();
        }

        // 3. Cek apakah ada file JS yang sesuai, lalu muat secara dinamis
        const scriptUrl = `halaman/${pageName}.js`;
        const scriptResponse = await fetch(scriptUrl);
        if (scriptResponse.ok) {
            const script = document.createElement('script');
            script.id = 'page-specific-script';
            script.src = scriptUrl;
            document.body.appendChild(script);
        }

    } catch (error) {
        console.error(`Error memuat halaman '${pageName}':`, error);
        showToast(`Gagal memuat halaman.`, 'error');
        appContent.innerHTML = `<p class="text-center text-red-500">Gagal memuat konten.</p>`;
    }
}

function renderDashboardPage() {
    appContent.innerHTML = `<header class="panel flex justify-between items-center"><div><h2 id="user-greeting" class="text-xl font-bold"></h2><p class="text-sm text-gray-400">Selamat datang di Command Center Anda.</p></div></header><div class="grid grid-cols-1 lg:grid-cols-3 gap-6"><div class="col-span-1 lg:col-span-2 space-y-6"><div class="panel"><h4 class="font-bold text-lg mb-4">Status Anda</h4><div id="status-container" class="space-y-4"></div></div></div><div class="col-span-1 space-y-6"><div class="panel"><h4 class="font-bold text-lg mb-4">Pencapaian</h4><div id="lencana-container" class="flex gap-4"></div></div></div></div>`;
    initializeAppDashboardWidgets();
}

function renderPengaturanPage() {
    const pengaturanHTML = `<div class="panel max-w-2xl mx-auto"><h2 class="text-2xl font-bold mb-1 text-cyan-400">Pengaturan</h2><p class="text-sm text-gray-400 mb-6">Kelola data aplikasi Anda di sini.</p><div class="bg-gray-900/50 p-4 rounded-lg"><div class="flex items-center justify-between"><div><h4 class="font-bold">Reset Progres Belajar</h4><p class="text-xs text-gray-400 mt-1">Aksi ini akan menghapus semua progres dan lencana Anda. Tidak dapat diurungkan.</p></div><button onclick="resetProgress()" class="bg-red-800 hover:bg-red-700 text-white text-sm font-bold py-2 px-4 rounded-lg flex-shrink-0">Reset Data</button></div></div></div>`;
    appContent.innerHTML = pengaturanHTML;
}

// =================================================================================
// BAGIAN 3: LOGIKA LOCALSTORAGE & WIDGET (GLOBAL)
// =================================================================================
function initializeAppDashboardWidgets() {
    const email = sessionStorage.getItem('sessionEmail') || 'pengguna@email.com';
    const namePart = email.split('@')[0];
    document.getElementById('user-greeting').innerHTML = `Halo, ${namePart.charAt(0).toUpperCase() + namePart.slice(1)} 👋`;
    
    const COMPLETED_KEY = 'userCompletedItems';
    let completed = JSON.parse(localStorage.getItem(COMPLETED_KEY)) || [];
    
    // Perhitungan total item sekarang bergantung pada data yang dimuat
    // Untuk dasbor, kita asumsikan data bank soal belum dimuat, jadi kita hitung manual
    const totalItems = masterContentList.length + 1; // Ganti 1 dengan jumlah bank soal jika dinamis
    
    if (completed.length > totalItems) {
      completed.length = totalItems;
    }

    const progress = totalItems > 0 ? Math.round((completed.length / totalItems) * 100) : 0;
    
    document.getElementById('status-container').innerHTML = `<div><span class="text-sm">📚 Progress Keseluruhan (${completed.length}/${totalItems})</span><div class="w-full bg-gray-700 rounded-full h-2.5 mt-1"><div class="bg-cyan-500 h-2.5 rounded-full transition-all duration-500" style="width: ${progress}%"></div></div></div>`;
    let lencanaHTML = '';
    if (completed.length >= 1) lencanaHTML += `<div title="Langkah Pertama"><i class="fa-solid fa-shoe-prints text-cyan-400 text-2xl"></i></div>`;
    if (progress >= 50) lencanaHTML += `<div title="Setengah Jalan!"><i class="fa-solid fa-road-circle-check text-green-400 text-2xl"></i></div>`;
    if (progress === 100) lencanaHTML += `<div title="100% Selesai!"><i class="fa-solid fa-trophy text-amber-400 text-2xl"></i></div>`;
    document.getElementById('lencana-container').innerHTML = lencanaHTML || `<p class="text-sm text-gray-500">Selesaikan materi untuk dapat lencana!</p>`;
}

function resetProgress() {
    const confirmation = confirm("Apakah Anda yakin ingin mereset semua progres belajar Anda? Aksi ini tidak dapat dibatalkan.");
    if (confirmation) {
        localStorage.removeItem('userCompletedItems');
        showToast("Progres belajar berhasil direset.", "success");
        navigateTo('dashboard', document.querySelector('.sidebar-link'));
    } else {
        showToast("Aksi reset dibatalkan.", "info");
    }
}

// =================================================================================
// BAGIAN 4: FUNGSI GLOBAL & INISIALISASI
// =================================================================================
function initializeApp() {
    const firstLink = document.querySelector('.sidebar-link');
    navigateTo('dashboard', firstLink);
}

function showToast(message, type = 'info') {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    const icons = { info: 'fa-solid fa-circle-info', success: 'fa-solid fa-check-circle', error: 'fa-solid fa-triangle-exclamation' };
    const colors = { info: 'text-cyan-400', success: 'text-green-400', error: 'text-red-400' };
    const iconClass = icons[type] || icons['info'];
    const colorClass = colors[type] || colors['info'];
    toast.className = 'toast-in flex items-start p-4 rounded-lg shadow-lg text-sm';
    toast.style.backgroundColor = 'var(--bg-panel)';
    toast.style.border = '1px solid var(--border-color)';
    toast.innerHTML = `<div class="flex-shrink-0"><i class="${iconClass} ${colorClass} text-xl"></i></div><div class="ml-3"><p class="font-bold capitalize ${colorClass}">${type}</p><p class="text-gray-300 mt-1">${message}</p></div>`;
    container.appendChild(toast);
    setTimeout(() => {
        toast.classList.remove('toast-in');
        toast.classList.add('toast-out');
        toast.addEventListener('animationend', () => { toast.remove(); });
    }, 5000);
}
</script>

</body>
</html>
